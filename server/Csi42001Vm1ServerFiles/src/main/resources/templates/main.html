<!DOCTYPE html>
<html>
    <head>
        <title>Who's there - Login</title>

        <link rel="stylesheet" type="text/css" href="../static/css/style.css" th:attr="href=@{/css/style.css}" />
<!--        <link rel="stylesheet" type="text/css" href="/css/style.css" th:attr="href=@{/css/style.css}" />-->
                
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        
        <script>
            //<![CDATA[
            var dataResponse = "";
            var url = '/api/tablesearch?request=Room&key=Buildling'
            var xmr = new XMLHttpRequest();
            xmr.open("GET", url, false);
            xmr.onreadystatechange = function(oEvent) {
            if (xmr.readyState === 4) {
                if (xmr.status === 200) {
                    dataResponse = JSON.parse(xmr.responseText);
                } else {
                    console.log("Error", xmr.statusText)
                }
            }
        }
            xmr.send(null);
            //]]>
        </script>
         
    </head>
    
    <body>
        <!-- Insert header -->
        <div id="header"></div>
        <script> 
            //<![CDATA[
            $(function(){
                $("#header").load("header.html");
            });
            //]]>
        </script>
    
        <!--  Search form: by building, module and date     -->
        <section id="search_section">
            <form id="search_form">
                <select id="building" class="search_select">
                    <option>Select a building</option>                 
                </select>
                <select id="classroom" class="search_select">
                    <option>Select a classroom</option>
                </select>
                <input type="date" name="date" class="search_select"/>
                <button type="submit" id="search_btn">Search</button>
            </form>
        </section>
        
        
        <!-- Insert navigation bar -->
                <aside id="nav_bar"></aside>
                    <script> 
                        //<![CDATA[
                        $(function(){
                            $("#nav_bar").load("nav_bar.html");
                        });
                        //]]>
                    </script>
            <main id="main">

            <!-- Map -->
            <section id="map"></section>
            
            <!-- Section for floor plan and classroom info  -->
            <section id="info_section">
                <button id="to_map_btn">Back to map</button>
                <h3 id="building_title"></h3>
                <p id="no_info_error"></p>
                <div id="floor_plan_wrap">
                    <img id="floor_plan"/>
                </div>
            </section>
            
            
            <script>
            document.getElementById("to_map_btn").addEventListener("click", showMap);

            function showMap() {
                document.getElementById("map").style.display = 'block';
                document.getElementById("info_section").style.display = 'none';
            }
            </script>

            <script>
                //<![CDATA[
                var x = document.getElementById("building");
                    for (var buildingkey in dataResponse){
                        var option = document.createElement("option");
                        option.text = dataResponse[buildingkey][0]["Building"];
                        x.add(option);
                    }

                    var classroom = document.getElementById("classroom");
                    building.addEventListener("change", function() {
                        classroom.innerHTML = "";
                        var option = document.createElement("option");
                        option.text = "Select a classroom";
                        classroom.add(option);
                        var optionList = building.querySelectorAll("option");
                        var selected = building.options[building.selectedIndex].text;
                        if (typeof dataResponse[selected] !== "undefined") {
                            for (var i = 0; i < dataResponse[selected].length; i++){
                                var option = document.createElement("option");
                                option.text = dataResponse[selected][i]["Room_no"];
                                classroom.add(option);
                            }
                        }
                    });            
                //]]>
            </script>

            <script>
                //<![CDATA[
                var map;
                function initMap() {
                    map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: 53.307722, lng: -6.222274},
                    zoom: 15,
                        //silvia: for moving the map controller on the right, so I can put nav bar on the left 
                    mapTypeControl: true,
                    mapTypeControlOptions: {
                        style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                        position: google.maps.ControlPosition.TOP_RIGHT
                        },
                    });
                    setMarkers();
                }

                // Place markers on the map over each building
                function setMarkers(){
                    var markers = [];
                    var marker;

                    // Coordinates for some buildings -  hardcoded for now - needs to be discussed
                    var buildingList = [
                        ["O’Brien Centre for Science (Hub)", 53.308274, -6.224443],
                        ["O’Brien Centre for Science (North)", 53.308970, -6.224218],
                        ["O’Brien Centre for Science (East)", 53.308470, -6.223633],
                        ["O’Brien Centre for Science (West)", 53.308265, -6.225269],
                        ["Computer Science and Informatics Centre", 53.309294, -6.223747],
                        ];

                    // Iterate through building list to place marker over each building
                    for (var i = 0; i < buildingList.length; i++){  
                        var name = buildingList[i][0];
                        var lat = buildingList[i][1];
                        var long = buildingList[i][2];        
                        var latlngset = new google.maps.LatLng(lat, long);

                        // Create new marker
                        var marker = new google.maps.Marker({  
                            map: map, 
                            title: name, 
                            position: latlngset
                        });
                        
                        // Give an id for marker matching building name in order to load 
                        // corresponding building information on click
                        marker.metadata = {type: "point", id: name};

                        // Add listener to marker: show info section
                        marker.addListener('click', function(){
                            document.getElementById("info_section").style.display = 'block';
                            document.getElementById("map").style.display = 'none';
                            displayBuildingInfo(this);
                        });

                        // Add marker to array
                        markers.push(marker);
                    }
                    
                    function displayBuildingInfo(marker){
                        document.getElementById("building_title").innerHTML = marker.metadata.id;
                        if(marker.metadata.id == "Computer Science and Informatics Centre"){
                            document.getElementById("floor_plan").src = "../static/img/CSI_floor_0.png";
                           document.getElementById("floor_plan").style.display = 'block'; document.getElementById("no_info_error").style.display = 'none';
                        }else{
                            document.getElementById("no_info_error").innerHTML = "Sorry, no information for this building yet"
                            document.getElementById("no_info_error").style.display = 'block';
                            document.getElementById("floor_plan").style.display = 'none';
                        }
                    }
                }
                
                //]]>
            </script>
            
            <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAysaK-xaVpMze3R5nJp1hniuflmN0tCfY&amp;callback=initMap"
            async = "async" defer = "defer"></script>

        </main>
         <!-- Insert footer -->
        <div id="footer"></div>
        <script> 
            //<![CDATA[
            $(function(){
                $("#footer").load("footer.html");
            });
            //]]>
        </script>
    </body>
</html>
    
