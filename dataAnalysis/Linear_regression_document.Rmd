---
title: "Linear Regression analysis"
author: "Silvia Saloni"
date: "Monday, July 25, 2016"
output: pdf_document
---
#Introduction

The aim of the project was to be able to find a model that best predict the relationship between:
* the number of people counted with the survey for a given class at a particular hour 
* Wi-fi log counted in that room at that hour

This will allow to see whether Wi-Fi log is a good predictor for estimating occupancy in a classroom.

We first tried to see if the relationship between this two variables was linear. To do so we run a linear regression.

Below we describes step by step all the analysis performed.

```{r, echo=FALSE, warning=FALSE}
#load all the libraries needed
library(RMySQL) #package for communicate with MySQL database
library(ggplot2) #package for making graphs
library(GGally)
library(nlme)
source("http://peterhaschke.com/Code/multiplot.R")
```

First of all, we set up the connection to the database, using the following code:

```{r}
connection <- dbConnect(MySQL(),user="root", password="",dbname="mysql", host="localhost")
```
Then we made a query to the database, in order to get all the groundth truth data collected in room B.002, B.004 and B.006 from 9 to 17 and the correspondent Wi-Fi Log measured in that time frame and rooms. 

```{r, echo=FALSE, warning=FALSE}
query <-"SELECT W.`Room_Room_id` as Room, W.`Date`, HOUR( W.Time ) as Time, T.`Module_Module_code` as Module, M.`Course_Level`,T.`Tutorial`, T.`Double_module`, T.`Class_went_ahead`, R.`Capacity`, G.`Percentage_room_full`, AVG(W.`Associated_client_counts`) as Average_clients, MAX(W.`Authenticated_client_counts`) as Max_clients FROM Room R, Wifi_log W, Ground_truth_data G, Time_table T, Module M WHERE W.Room_Room_id = R.Room_id AND G.Room_Room_id = W.Room_Room_id AND W.Date = G.Date AND HOUR( W.Time ) = HOUR( G.Time ) AND HOUR( W.Time ) = HOUR( T.Time_period ) AND T.Date = W.Date AND T.Room_Room_id = W.Room_Room_id AND M.`Module_code` = T.`Module_Module_code` GROUP BY W.Room_Room_id, HOUR( W.Time ) , W.Date"

#select the data based on the query and store them in a dataframe called Analysis table
AnalysisTable <-dbGetQuery(connection, query)
```

The dataset created had in total 216 rows and it will allow us to explore if Wi-Fi log is a good predictor of the observed occupancy of the room in that particular hour.

As a target features for our linear regression we decided to use the number of associated client, calculated multiplying the percentage of the room full with the capacity of the room.
```{r, echo=FALSE,warning=FALSE}
#create the new column for getting number of people counted through ground truth data
AnalysisTable$Counted_client <- AnalysisTable$Capacity * AnalysisTable$Percentage_room_full
```
As response variables or feature we considered Wi-Fi logs, which were summarised either as average of the logs counted for each room and for each hour or as maximum of the logs measured for each room and for each hour. 

Together with the Wi-Fi log, we included in the data set the following features: 

* Date, which we did not use in this analysis, because they just cover 2 weeks of Novemeber, but for future analyses they can be used to group observations by seasons or semesters or to finds seasonal trends for time series analyses.

* Time, which will be explored either as continous variable and as categorical to explore if the time of the day can have an affect on the Wi-Fi log. To do so we, bin the time in 4 ranges: early morning (9-11), late morning (11-13), early afternoon (13-15) and late afternoon (15-17). 
```{r, echo=FALSE, warning=FALSE}
AnalysisTable$Factor_Time <-cut(AnalysisTable$Time, breaks = 4, right=FALSE, labels=c('Early Morning','Late Morning','Early Afternoon','Late Afternoon' ))
```
This will allow us to see if the Wi-Fi log accuracy was changing during the day. For example, it is more likely that early morning all the elctronic devices are fully powered and consequently the Wi-fi log data can be more accurate or overestimating the occupancy of the room (i.e. more than one device per person). On the contrary in the afternoon, the devices may be more likely to be out of battery and it is possible that there are less devices in the room. 

* Module, which we are not going to include in the analysis because the majority of the module present are for computer science, but for future analyses it will be possible to explore if the Wi-fi log accuracy in predicting the occupancy change acroos the courses. Science course or computer science course will more likely to use electronic devices during lecture than art students.

* Course level, which can indicate us whether electronic devices will be less used during different course level. For example, first and second level course can be less practical and therefore laptop are not needed and that can decrease the number of devices connected. On the other hand, undergraduate might be more distracted during lecture and look at their phones during lectures. This will result in an increase of connection in that hour.

```{r, echo=FALSE, warning=FALSE}
AnalysisTable$Course_Level <- factor(AnalysisTable$Course_Level)
```

* Tutorial, which can affect the number of logged people. First of all, because tutorial divided the room in 2 and therefore there will be measured less people than expected. 
```{r, echo=FALSE, warning=FALSE}
AnalysisTable$Double_module <- factor(AnalysisTable$Double_module)
AnalysisTable$Class_went_ahead <- factor(AnalysisTable$Class_went_ahead)
```

* Double_module, categorical variable indicating wether in the class there are more than one module, increasing the number of people expected in the room.
```{r, echo=FALSE}
AnalysisTable$Double_module <- factor(AnalysisTable$Double_module)
```

* Double_module, categorical variable indicating wether in the class went ahead to correct the .
```{r, echo=FALSE}
AnalysisTable$Class_went_ahead <- factor(AnalysisTable$Class_went_ahead)
```

The resulting data set is printed below:
```{r}
head(AnalysisTable)
```

## DATA QUALITY REPORT

Before running any analyses, we carried out the data quality report to check for any issue related to the variable (e.g. outlier, skewed distribution, NaN values) and solutions we will implement to solve them.

Initially we printed the descriptive statistic for all the features and the presence of NaN values.
```{r}
summary(AnalysisTable)
```
From this we could see that NaN values were not present in the data set. Furthermore, we could notice that the observations for the features Tutorials and Double_model were not even didtributed across the 2 levels of the variables. In fact, only 6 observation were present for tutorial class and for double module class. Therefore, we decided to discard both the features, because they will be not informative for the analysis. Similarly for the feature class_went_ahead, it results that the majority of the lectures did occur and we decided to discard it.

For the remaining variables we decided to plot:

* histograms and boxplots for continuous variables for exploring their distributions and check for outliers.

* bar plot for categorical features.

### Histograms

```{r, echo=FALSE,warning=FALSE}
histo1 <- ggplot(AnalysisTable, aes(x = Max_clients)) + geom_histogram(binwidth = 10,  col="red", aes(fill=..count..)) + scale_fill_gradient("Count", low = "yellow", high = "red") +theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) 

histo2 <- ggplot(AnalysisTable, aes(x = Average_clients)) + geom_histogram(binwidth = 10,  col="red", aes(fill=..count..)) + scale_fill_gradient("Count", low = "yellow", high = "red") +theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) 


histo3 <- ggplot(AnalysisTable, aes(x = Counted_client)) + geom_histogram(binwidth = 10,  col="red", aes(fill=..count..)) + scale_fill_gradient("Count", low = "yellow", high = "red") +theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) 

histo4 <- ggplot(AnalysisTable, aes(x = Time)) + geom_histogram(binwidth = 2,  col="red", aes(fill=..count..)) + scale_fill_gradient("Count", low = "yellow", high = "red") +theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) 
#plot all the histograms in one window
multiplot(histo1, histo2, histo3, histo4, cols=2)
```
\n
Form the histograms we could see that the distribution of the feature Maximum_client (i.e. the Maximum number of devices logged in one hour lecture) was skewed to the left, indicating that the in the majority of the lecture were counted no more than 40 people. Similar was the case for the Average_client (i.e. average number of devices logged in one hour lecture), which indicated that in the class there were no more than 40 people.
Different was the situation of the target feature, Counted client, which showed a skewed distribution, but more scattered, similar to a Poisson distribution. This can cause a problem in running a linear regression and more likely we have have to run a generalise linear model with a Poisson distribution. This is not surprising, since we are dealing with count data (Zuur et al. 2009).
Feature times had as well a skewed distribution, suggesting that the majority of the lectures were concentrating during the early morning and they were decreasing towards the afternoon.

### Boxplots

```{r, echo=FALSE, warning=FALSE}
#make the boxplot for continuous variable
box1 <- ggplot(AnalysisTable, aes(x = factor(0), y = Counted_client)) + geom_boxplot() + xlab("Expected students") + scale_x_discrete(breaks = NULL) + coord_flip() + theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) 

box2 <- ggplot(AnalysisTable, aes(x = factor(0), y = Average_clients)) + geom_boxplot() + xlab("Average counted students") + scale_x_discrete(breaks = NULL) + coord_flip() + theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) 

box3 <- ggplot(AnalysisTable, aes(x = factor(0), y =Max_clients)) + geom_boxplot() + xlab("Maximum counted students") + scale_x_discrete(breaks = NULL) + coord_flip() + theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) 

box4 <- ggplot(AnalysisTable, aes(x = factor(0), y = Time)) + geom_boxplot() + xlab("Maximum counted students") + scale_x_discrete(breaks = NULL) + coord_flip() + theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) 
#plot all the boxplots in one window
multiplot(box1, box2, box3, box4, cols=2)
```

From the boxplots, we can see that: 
############################GRAPH FOR CATEGORICAL DATA##################################

bar1 <- ggplot(AnalysisTable, aes(x = Room)) + geom_bar(fill="seagreen4")+ theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) 

bar2 <- ggplot(AnalysisTable, aes(x = Course_Level)) + geom_bar(fill="seagreen4")+ theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) 

bar3 <- ggplot(AnalysisTable, aes(x = Binned_Percentage)) + geom_bar(fill="seagreen4")+ theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) 

bar4 <- ggplot(AnalysisTable, aes(x = Binned_Time)) + geom_bar(fill="seagreen4")+ theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) 

#bar2 <- ggplot(AnalysisTable, aes(x = Module)) + geom_bar(fill="seagreen4")
#bar3 <- ggplot(AnalysisTable, aes(x = Tutorial)) + geom_bar(fill="seagreen4")
#bar4 <- ggplot(AnalysisTable, aes(x = Double_module)) + geom_bar(fill="seagreen4")
#bar5 <- ggplot(AnalysisTable, aes(x = Class_went_ahead)) + geom_bar(fill="seagreen4

multiplot(bar1, bar2, bar3, bar4, cols=2)

#######RELATIONSHIP BETWEEN Variables #############################

##CASE 1: TARGET FEATURE = Counted_clients 
#--> Relationship with continous variables

# Correlation Matrix
ggpairs(AnalysisTable, columns = c('Counted_client','Max_clients', 'Average_clients', 'Time'))+ geom_point() +  geom_smooth(method=lm, fill="blue", color="blue", ...)

my_fn <- function(data, mapping, ...){
  p <- ggplot(data = data, mapping = mapping) + 
    geom_point() + 
    geom_smooth(method=lm, fill="orangered3", color="orangered3", ...)
  p
}

ggpairs(AnalysisTable, columns = c('Counted_client','Max_clients', 'Average_clients', 'Time'), lower = list(continuous = my_fn)) + theme_bw()

#--> Relationship with categorical variables

#Box plot
pairbox1 <- ggplot(AnalysisTable, aes(x = Room, y =Counted_client)) + geom_boxplot()+ theme_bw()+theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) 

pairbox2 <- ggplot(AnalysisTable, aes(x = Binned_Time , y = Counted_client)) + geom_boxplot() + theme_bw()+theme( panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) 

pairbox3 <- ggplot(AnalysisTable, aes(x = Course_Level , y = Counted_client )) + geom_boxplot() + theme_bw()+theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) 


multiplot(pairbox1, pairbox2, pairbox3, cols=3)

#######RELETIONSHIP BETWEEN TARGET FEATURE AND CATEGORICAL VARIABLE##############################

##CASE 1: TARGET FEATURE = Counted_clients

#Box plot

pairbox4 <- ggplot(AnalysisTable, aes(x = Binned_Capacity, y =Average_clients)) + geom_boxplot()+ theme_bw()+theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) 

pairbox5 <- ggplot(AnalysisTable, aes(x = Binned_Capacity, y = Max_clients)) + geom_boxplot() + theme_bw()+theme( panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) 

pairbox6 <- ggplot(AnalysisTable, aes(x =Binned_Capacity, y = Time )) + geom_boxplot() + theme_bw()+theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) 

multiplot(pairbox4, pairbox5, pairbox6, cols=3)

##CASE 2: TARGET FEATURE IS CATEGORICAL 

barpair1 <- ggplot(AnalysisTable, aes(x = Binned_Percentage, fill = Room)) + geom_bar(position = "dodge")+ scale_fill_manual(values=c( "cyan4","yellow","orange"))+theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

barpair2 <- ggplot(AnalysisTable, aes(x = Binned_Percentage, fill = Binned_Time)) + geom_bar(position = "dodge")+ scale_fill_manual(values=c("blue", "cyan4","yellow","orange"))+theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

barpair3 <- ggplot(AnalysisTable, aes(x = Binned_Percentage, fill = Course_Level)) + geom_bar(position = "dodge")+ scale_fill_manual(values=c( "darkblue","blue","cyan4","yellow","orange"))+theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

multiplot(barpair1, barpair2, barpair3, cols=3)

ggplot(cabbage_exp, aes(x=Date, y=Weight, fill=Cultivar)) + 
  geom_bar(position='dodge', stat='identity')

ggplot(AnalysisTable, aes(x = Binned_Percentage, y =Counted_client, fill = Room)) + geom_bar(position = "dodge", stat='identity')+ scale_fill_manual(values=c( "cyan4","yellow","orange"))+theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

occupancy.lm = lm(Counted_client ~ Max_clients + Room + Binned_Time + Course_Level + Course_Level * Max_clients + Binned_Time*Course_Level, data=AnalysisTable)
summary(occupancy.lm)
plot(occupancy.lm)



plot(occupancy.lm, which = c(1), col = 1, add.smooth = FALSE, caption)

plot(AnalysisTable$Max_clients, resid(occupancy.lm), xlab = "Max_clients", ylab = "Residuals")
plot(AnalysisTable$Room, resid(occupancy.lm), xlab = "Room", ylab = "Residuals")
plot(AnalysisTable$Binned_Time, resid(occupancy.lm), xlab = "Binned_Time", ylab = "Residuals")
plot(AnalysisTable$Course_Level, resid(occupancy.lm), xlab = "Course_Level", ylab = "Residuals")


#Trellis
qplot(Average_clients, Counted_client, data = AnalysisTable, facets = . ~ Room) + geom_smooth(method=lm, fill="orangered3", color="orangered3")

qplot(Average_clients, Counted_client, data = AnalysisTable, facets = . ~ Binned_Time) + geom_smooth(method=lm, fill="orangered3", color="orangered3")

qplot(Average_clients, Counted_client, data = AnalysisTable, facets = . ~ Course_Level) + geom_smooth(method=lm, fill="orangered3", color="orangered3")

qplot(Max_clients, Counted_client, data = AnalysisTable, facets = . ~ Room) + geom_smooth(method=lm, fill="orangered3", color="orangered3")

qplot(Max_clients, Counted_client, data = AnalysisTable, facets = . ~ Binned_Time) + geom_smooth(method=lm, fill="orangered3", color="orangered3")

qplot(Max_clients, Counted_client, data = AnalysisTable, facets = . ~ Course_Level) + geom_smooth(method=lm, fill="orangered3", color="orangered3")

# Bar plots
ggplot(AnalysisTable, aes(x = Binned_Time, y = Counted_client, fill = factor(Room))) + geom_bar(position = "dodge", stat="identity")+ scale_fill_manual(values=c( "darkblue","cyan4", "yellow"))+theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

ggplot(AnalysisTable, aes(x = Course_Level, y = Counted_client, fill = factor(Room))) + geom_bar(position = "dodge", stat="identity")+ scale_fill_manual(values=c( "darkblue","cyan4", "yellow", "orange", "blue"))+theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

ggplot(AnalysisTable, aes(x = Binned_Time, y = Counted_client, fill = factor(Course_Level))) + geom_bar(position = "dodge", stat="identity")+ scale_fill_manual(values=c( "darkblue","cyan4", "yellow", "orange", "blue"))+theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

ggplot(AnalysisTable, aes(x = Binned_Time, y = Average_clients, fill = factor(Room))) + geom_bar(position = "dodge", stat="identity")+ scale_fill_manual(values=c( "darkblue","cyan4", "yellow", "orange"))+theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

ggplot(AnalysisTable, aes(x = Binned_Time, y = Average_clients, fill = factor(Course_Level))) + geom_bar(position = "dodge", stat="identity")+ scale_fill_manual(values=c( "darkblue","cyan4", "yellow", "orange"))+theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

ggplot(AnalysisTable, aes(x = Room, y = Average_clients, fill = factor(Course_Level))) + geom_bar(position = "dodge", stat="identity")+ scale_fill_manual(values=c( "darkblue","cyan4", "yellow", "orange", "blue"))+theme_bw()+theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

# Linear Regression

occupancy.lm = lm(Counted_client ~ Max_clients + Room + Binned_Time + Course_Level + Course_Level * Max_clients + Binned_Time * Course_Level, data=AnalysisTable)
summary(occupancy.lm)
plot(occupancy.lm)

occupancy.glm = lm(Counted_client ~ Max_clients + Room + Binned_Time + Course_Level + Course_Level * Max_clients + Binned_Time * Course_Level, data=AnalysisTable)

# Glm with poisson distribution
occupancy.poisson1 = glm(Counted_client ~ Max_clients + Room + Binned_Time + Course_Level + Course_Level * Max_clients + Binned_Time * Course_Level, family = poisson, data=AnalysisTable)
summary(occupancy.poisson1)
plot(occupancy.poisson1)

occupancy.poisson2 = glm(Counted_client ~ Max_clients + Room + Binned_Time + Course_Level + Course_Level * Max_clients + Binned_Time * Course_Level, family = quasipoisson, data=AnalysisTable)
summary(occupancy.poisson2)
plot(occupancy.poisson2)



library(MASS)
occupancy.negbinomial <- glm.nb(Counted_client ~ Max_clients + Room + Binned_Time + Course_Level + Course_Level * Max_clients + Binned_Time * Course_Level, link = "log", data=AnalysisTable)

plot(occupancy.negbinomial)
warnings()


# Logistic Regression
library(nnet)

glm.fit=multinom(Binary_Percentage ~ Max_clients + Room + Binned_Time + Course_Level, family = binomial, data=AnalysisTable)
summary(glm.fit)
#Prediction
predict(glm.fit, AnalysisTable, "probs")




vf5 <- varExp(form =~ Max_clients)
M.gls5 <- gls(Counted_client ~ Max_clients + Room + Binned_Time + Course_Level + Course_Level * Max_clients + Binned_Time*Course_Level, weights = vf5, data=AnalysisTable)




vf1<- varFixed(~ Max_clients)
M.gls <- gls(Counted_client ~ Max_clients + Room + Course_Level , weights = vf1, data=AnalysisTable)  
